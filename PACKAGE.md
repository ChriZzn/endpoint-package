# The Endpoint Package

The Endpoint package handles installing mapping templates, ILM policies, ingest pipelines, and other functionality
that should be done prior to the Endpoint streaming data to ES and using the Endpoint app in Kibana.

The Endpoint package is located [here](https://github.com/elastic/package-registry/tree/master/dev/packages/example/endpoint-1.0.0)

To update the endpoint package clone the <https://github.com/elastic/package-registry> and make changes as needed

## Testing Changes

To test changes to the Endpoint package you will need to point your Kibana at a locally running package registry. To
run the package registry follow the instructions in the [package registry](https://github.com/elastic/package-registry/blob/master/README.md#running)

Here are the distilled steps:

- Install go 1.13 from here: <https://golang.org/dl/>

- Install [mage](https://github.com/magefile/mage#installation)

From the root directory

```bash
mage build
go run .
```

Note: You will need to rerun `mage build` after making additional changes to a package.

Add the follow flags to your `kibana.dev.yaml` file

```yaml
xpack.ingestManager.enabled: true
xpack.ingestManager.epm.registryUrl: "http://127.0.0.1:8080"
xpack.ingestManager.epm.enabled: true
xpack.ingestManager.fleet.enabled: true
```

The Ingest Manager will now use your locally running package registry for retrieving a package.

## Updating the Endpoint Package Mapping

To update the endpoint package mapping take a look at the [Custom Schema](./custom_schemas/README.md) and
[Custom Subset](./custom_subsets/README.md) first to get an understanding of what makes up the mapping.

The essential steps are listed here:

- Edit/add custom schema files as needed to define any fields that don't exist in ECS core

- Update the subset files for the particular event that is being changed or create a new subset file

- Generate the mapping

```bash
cd ecs
python scripts/generator.py --out ../<some directory to write the generated files> --include ../endpoint-app-team/custom_schemas --subset ../endpoint-app-team/custom_subsets/<subset file(s) being used>
```

Here are some examples:

### Generating the events mapping

```bash
python scripts/generator.py --out ../gen --include ../endpoint-app-team/custom_schemas --subset ../endpoint-app-team/custom_subsets/elastic_endpoint/events/* ../endpoint-app-team/custom_subsets/*.yml
```

### Generating the metadata mapping

```bash
python scripts/generator.py --out ../gen --include ../endpoint-app-team/custom_schemas --subset ../endpoint-app-team/custom_subsets/elastic_endpoint/metadata/*
```

The generated files will be in `../gen` in the examples above. The file needed to update the mapping is in
`../gen/generated/beats/fields.ecs.yml`

The file format needs to be updated slightly before being included in the package. To get the file in the right format
remove these lines:

```yaml
# WARNING! Do not edit this file directly, it was generated by the ECS project,
# based on ECS version 1.5.0-dev.
# Please visit https://github.com/elastic/ecs to suggest changes to ECS fields.

- key: ecs
  title: ECS
  description: ECS Fields.
  fields:
```

Next, remove the indentation. Now copy this file to <https://github.com/elastic/package-registry/blob/master/dev/packages/example/endpoint-1.0.0/dataset/events/fields/fields.yml>
if you are updating the `events` mapping, the `metadata` file is here: <https://github.com/elastic/package-registry/blob/master/dev/packages/example/endpoint-1.0.0/dataset/metadata/fields/fields.yml>

Rerun `mage build` and `go run .` and the endpoint package should have the latest mapping changes in it. You will probably
have to restart ES and Kibana because the Ingest Manager keeps the installed packages in a cache so it might not try to
pull down the latest one (upgrading a package hasn't been implemented as of 4/9/20 when writing this README).

### Versioning

Most of this section is still TODO but if we update the mapping in a way that is not a breaking change
we'll probably need to update the version of the package. To update the package version specified here:
<https://github.com/elastic/package-registry/blob/master/dev/packages/example/endpoint-1.0.0/manifest.yml#L5>
